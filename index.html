<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dhusamareb Road Package 1 Labour Management Record</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Orbitron font for unique IP styling -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles using Biciv Design inspired colors (Blue/Cyan/Grey) */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* Light background */
        }
        .container {
            max-width: 1200px;
        }
        .form-card {
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            overflow-x: auto;
            max-height: 70vh;
        }
        /* Sticky header for scrollable tables */
        th {
            position: sticky;
            top: 0;
            background-color: #dbeafe; /* Light Blue 100 for header */
            z-index: 10;
        }
        .attendance-header th {
            background-color: #fef3c7; /* Light Yellow/Amber for Attendance header */
        }
        .payments-header th {
            background-color: #d1fae5; /* Light Green for Payments header */
        }
        /* Unique font style for the Intellectual Property footer */
        .ip-font {
            font-family: 'Orbitron', sans-serif;
            font-weight: 700;
        }
    </style>
    <!-- Load Firebase Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            serverTimestamp,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable debug logging for Firebase
        setLogLevel('Debug');

        let db, auth;
        let userId = '';
        let isAuthReady = false; // New flag to track authentication state
        
        // Firestore Collection References
        let registerCollection, attendanceCollection, paymentsCollection;
        
        // Global Data Stores for UI rendering and Export
        let workersMap = {};    // Firestore ID -> Worker Data (for fast lookups)
        let workersList = [];   // Array of workers for Register display and export
        let attendanceList = [];// Array of attendance records for display and export
        let paymentsList = [];  // Array of payment records for display and export

        // =================================================================================
        // *** CRITICAL STEP FOR GITHUB PAGES HOSTING: YOUR CONFIG IS NOW HARDCODED BELOW ***
        //
        // This configuration will be used when the application runs outside of the Canvas environment.
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDXfRbkP6V8raE3bxXSzoXFAsjZj9ODC_Y",
            authDomain: "dhuusamareeb-p1-main-road.firebaseapp.com",
            projectId: "dhuusamareeb-p1-main-road",
            storageBucket: "dhuusamareeb-p1-main-road.firebasestorage.app",
            messagingSenderId: "901867324894",
            appId: "1:901867324894:web:bc671312c0ed62ceff894f",
            measurementId: "G-WTPP9CD88F"
        };
        
        // This is your Firebase Project ID, used for structuring the public data path.
        const MANUAL_APP_ID = 'dhuusamareeb-p1-main-road';

        // --- Determine Configuration Source ---
        // Checks if the Canvas global config is available, otherwise uses the manual config.
        const firebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config 
            ? JSON.parse(__firebase_config) 
            : MANUAL_FIREBASE_CONFIG;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : MANUAL_APP_ID;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // =================================================================================

        // UI Elements
        const authStatusElement = document.getElementById('auth-status');
        const errorAlert = document.getElementById('error-alert');
        const successAlert = document.getElementById('success-alert');
        const contentViews = {
            register: document.getElementById('register-view'),
            attendance: document.getElementById('attendance-view'),
            payments: document.getElementById('payments-view')
        };
        const registerForm = document.getElementById('register-form');
        const workerListBody = document.getElementById('worker-list-body');
        const attendanceForm = document.getElementById('attendance-form');
        const attendanceListBody = document.getElementById('attendance-list-body');
        const paymentsForm = document.getElementById('payments-form');
        const paymentsListBody = document.getElementById('payments-list-body');
        const workerSelects = document.querySelectorAll('.worker-select');


        // --- Utility Functions ---

        // Function to enable/disable all interactive buttons during authentication/error
        function setFormStatus(enabled) {
            document.querySelectorAll('.form-submit-btn').forEach(btn => {
                btn.disabled = !enabled;
                if (enabled) {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            });
        }


        // Function to switch visible content view
        window.switchView = function(viewName) {
            Object.keys(contentViews).forEach(key => {
                contentViews[key].classList.add('hidden');
                document.getElementById(`tab-${key}`).classList.remove('border-cyan-500', 'text-blue-800');
                document.getElementById(`tab-${key}`).classList.add('border-transparent', 'text-gray-500');
            });
            contentViews[viewName].classList.remove('hidden');
            document.getElementById(`tab-${viewName}`).classList.add('border-cyan-500', 'text-blue-800');
            document.getElementById(`tab-${viewName}`).classList.remove('border-transparent', 'text-gray-500');
        }

        // Utility to show temporary messages
        function showAlert(element, message, duration = 3000) {
            element.textContent = message;
            element.classList.remove('hidden');
            element.classList.add('flex');
            setTimeout(() => {
                element.classList.add('hidden');
                element.classList.remove('flex');
            }, duration);
        }
        
        // Populate worker dropdowns
        function populateWorkerSelects() {
            workerSelects.forEach(select => {
                const selectedValue = select.value;
                select.innerHTML = '<option value="" disabled selected>Select Worker</option>';
                // Sort workers by their custom workerNo
                workersList.sort((a, b) => (a.data.workerNo || '').localeCompare(b.data.workerNo || ''));
                
                workersList.forEach(worker => {
                    const option = document.createElement('option');
                    // Use the Firestore ID as the value for lookups, display the custom Worker No
                    option.value = worker.id;
                    const displayNo = worker.data.workerNo ? `[${worker.data.workerNo}] ` : '';
                    option.textContent = `${displayNo}${worker.data.workerFullName} (${worker.data.tradeRole})`;
                    if (worker.id === selectedValue) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                });
            });
        }

        // --- Data Export Functions (CSV) ---

        // Helper to format timestamp into a readable string
        function formatTimestamp(timestamp) {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleString('en-US', { 
                    year: 'numeric', month: '2-digit', day: '2-digit', 
                    hour: '2-digit', minute: '2-digit', second: '2-digit',
                    hour12: false
                });
            }
            return '';
        }

        function convertToCSV(data, headers) {
            let csv = headers.join(',') + '\n';
            data.forEach(row => {
                let line = headers.map(header => {
                    // Check if the value is defined and escape commas/quotes
                    let value = row[header] !== undefined ? row[header] : '';
                    
                    if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                        value = `"${value.replace(/"/g, '""')}"`;
                    }
                    return value;
                }).join(',');
                csv += line + '\n';
            });
            return csv;
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showAlert(successAlert, `Downloaded ${filename} successfully!`);
            }
        }

        window.downloadAllData = function() {
            if (workersList.length === 0) {
                showAlert(errorAlert, "No worker data available to download yet.");
                return;
            }

            // --- 1. Labour Register Export ---
            const registerHeaders = ["Worker ID (Ref)", "workerNo", "workerFullName", "nationalId", "homeLocation", "contactPhone", "skillLevel", "sex", "tradeRole", "startDate", "remarks", "createdAt"];
            const registerData = workersList.map(w => {
                const data = w.data;
                return {
                    "Worker ID (Ref)": w.id, // Keep Firestore ID for backend reference
                    ...data,
                    createdAt: formatTimestamp(data.createdAt) // Formatted timestamp
                };
            });
            downloadCSV(convertToCSV(registerData, registerHeaders), `Labour_Register_Export_${new Date().toISOString().slice(0, 10)}.csv`);

            // --- 2. Daily Attendance Export ---
            const attendanceHeaders = ["workerNo", "workerFullName", "date", "location", "status", "hoursWorked", "remarks", "createdAt"];
            const attendanceData = attendanceList.map(a => {
                const worker = workersMap[a.workerId] || { workerNo: 'N/A', workerFullName: 'N/A' };
                return {
                    workerNo: worker.workerNo,
                    workerFullName: worker.workerFullName,
                    date: new Date(a.date).toLocaleDateString(),
                    location: a.location,
                    status: a.status,
                    hoursWorked: a.hoursWorked,
                    remarks: a.remarks,
                    createdAt: formatTimestamp(a.createdAt) // Formatted timestamp
                };
            });
            downloadCSV(convertToCSV(attendanceData, attendanceHeaders), `Daily_Attendance_Export_${new Date().toISOString().slice(0, 10)}.csv`);

            // --- 3. Wage Payments Export ---
            const paymentsHeaders = ["workerNo", "workerFullName", "paymentDate", "dailyRate", "daysWorked", "grossPay", "deductions", "netPay", "paymentMethod", "referenceNo", "createdAt"];
            const paymentsData = paymentsList.map(p => {
                const worker = workersMap[p.workerId] || { workerNo: 'N/A', workerFullName: 'N/A' };
                return {
                    workerNo: worker.workerNo,
                    workerFullName: worker.workerFullName,
                    paymentDate: new Date(p.paymentDate).toLocaleDateString(),
                    dailyRate: p.dailyRate?.toFixed(2),
                    daysWorked: p.daysWorked,
                    grossPay: p.grossPay?.toFixed(2),
                    deductions: p.deductions?.toFixed(2),
                    netPay: p.netPay?.toFixed(2),
                    paymentMethod: p.paymentMethod,
                    referenceNo: p.referenceNo,
                    createdAt: formatTimestamp(p.createdAt) // Formatted timestamp
                };
            });
            downloadCSV(convertToCSV(paymentsData, paymentsHeaders), `Wage_Payments_Export_${new Date().toISOString().slice(0, 10)}.csv`);
        }


        // --- Firebase Initialization ---

        async function initFirebase() {
            // CRITICAL FIX: Disable forms until auth is complete
            setFormStatus(false); 
            
            if (!firebaseConfig) {
                const configError = "Firebase configuration is missing! Please obtain your config object from the Firebase console and paste it into the 'MANUAL_FIREBASE_CONFIG' variable in the script to run this outside of the Canvas environment.";
                console.error(configError);
                authStatusElement.innerHTML = `<span class="text-red-600">${configError}</span>`;
                showAlert(errorAlert, configError, 10000);
                return; 
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Authentication Listener
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true; // Set flag
                        authStatusElement.innerHTML = `âœ… Connected as User ID: <span class="font-mono text-xs p-1 bg-green-100 rounded">${userId}</span>`;
                        
                        // Define public collection paths using the provided or manual app ID
                        const base = `/artifacts/${appId}/public/data`;
                        registerCollection = collection(db, `${base}/labour_register`);
                        attendanceCollection = collection(db, `${base}/daily_attendance`);
                        paymentsCollection = collection(db, `${base}/wage_payments`);
                        
                        // 2. Start listening to data once authenticated and collections are defined
                        startRealtimeListeners();
                        switchView('register'); // Default view
                        setFormStatus(true); // Re-enable forms on success
                        unsubscribe(); // Stop listening after successful sign-in
                    } else {
                        // Attempt sign in with custom token (Canvas environment) or anonymously (GitHub Pages)
                        authStatusElement.innerHTML = `âš ï¸ Authenticating...`;
                        if (initialAuthToken) {
                            // Canvas environment auth flow
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // GitHub Pages / Manual hosting auth flow
                            await signInAnonymously(auth);
                        }
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization/Authentication Error:", error);
                authStatusElement.textContent = `âŒ Critical Error: ${error.message}. Check your Firebase config and Firestore rules.`;
                showAlert(errorAlert, `Critical Error: ${error.message}. See console for details.`, 8000);
                setFormStatus(false); // Keep forms disabled on critical error
            }
        }

        // --- Realtime Data Listeners (onSnapshot) ---

        function startRealtimeListeners() {
            // Guard clause: Ensure we are authenticated before starting listeners
            if (!isAuthReady || !db) {
                console.warn("Attempted to start listeners before authentication was ready.");
                return;
            }

            // Listener 1: Labour Register (Worker Map Builder)
            onSnapshot(query(registerCollection), (snapshot) => {
                workerListBody.innerHTML = '';
                workersMap = {};
                workersList = [];
                let workerIndex = 1;
                
                snapshot.forEach((doc) => {
                    const worker = doc.data();
                    const workerId = doc.id;
                    
                    // Populate worker lookup map and list
                    workersMap[workerId] = worker;
                    workersList.push({ id: workerId, data: worker });
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    
                    const startDate = worker.startDate ? new Date(worker.startDate).toLocaleDateString() : 'N/A';
                    const customWorkerNo = worker.workerNo || 'N/A';

                    row.innerHTML = `
                        <td class="p-4 text-center">${workerIndex++}</td>
                        <td class="p-4 font-semibold text-blue-700">${worker.workerFullName || ''}</td>
                        <td class="p-4 text-sm font-mono">${customWorkerNo}</td>
                        <td class="p-4">${worker.nationalId || ''}</td>
                        <td class="p-4">${worker.homeLocation || ''}</td>
                        <td class="p-4">${worker.contactPhone || ''}</td>
                        <td class="p-4 text-center">${worker.skillLevel || ''}</td>
                        <td class="p-4 text-center">${worker.sex || ''}</td>
                        <td class="p-4">${worker.tradeRole || ''}</td>
                        <td class="p-4">${startDate}</td>
                        <td class="p-4 text-sm text-gray-500">${worker.remarks || ''}</td>
                        <td class="p-4 text-center">...</td>
                    `;
                    workerListBody.appendChild(row);
                });
                
                if (workersList.length === 0) {
                    workerListBody.innerHTML = '<tr><td colspan="12" class="p-6 text-center text-gray-500">No workers registered yet.</td></tr>';
                }

                // Important: Re-populate selects whenever the worker list updates
                populateWorkerSelects();
            }, (error) => {
                // *** IMPROVED ERROR LOGGING FOR DEBUGGING ***
                console.error("Firestore Register Snapshot Error:", error);
                const errorMessage = error.message.includes('permission denied') 
                    ? "ðŸ”´ PERMISSION DENIED: Check your Firestore Security Rules." 
                    : `Failed to fetch register data: ${error.message}`;
                showAlert(errorAlert, errorMessage);
                workerListBody.innerHTML = `<tr><td colspan="12" class="p-6 text-center text-red-500 font-bold">${errorMessage}</td></tr>`;
            });

            // Listener 2: Daily Attendance
            onSnapshot(query(attendanceCollection), (snapshot) => {
                attendanceListBody.innerHTML = '';
                attendanceList = []; // Reset list
                let recordIndex = 1;
                snapshot.forEach((doc) => {
                    const record = doc.data();
                    attendanceList.push(record); // Add to export list
                    const worker = workersMap[record.workerId] || {}; // Lookup worker info
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';

                    const statusClass = record.status === 'P' ? 'bg-green-100 text-green-700' : 
                                        record.status === 'L' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700';
                    
                    const displayNo = worker.workerNo || record.workerId.substring(0, 5) + '...';

                    row.innerHTML = `
                        <td class="p-4 text-center">${recordIndex++}</td>
                        <td class="p-4">${new Date(record.date).toLocaleDateString()}</td>
                        <td class="p-4 text-sm font-mono">${displayNo}</td>
                        <td class="p-4">${worker.workerFullName || 'N/A'}</td>
                        <td class="p-4">${record.location || 'N/A'}</td>
                        <td class="p-4 text-center font-bold ${statusClass}">${record.status || ''}</td>
                        <td class="p-4 text-center">${record.hoursWorked || 0}</td>
                        <td class="p-4 text-sm text-gray-500">${record.remarks || ''}</td>
                    `;
                    attendanceListBody.appendChild(row);
                });
                
                if (attendanceList.length === 0) {
                    attendanceListBody.innerHTML = '<tr><td colspan="8" class="p-6 text-center text-gray-500">No attendance records yet.</td></tr>';
                }
                
            }, (error) => {
                // *** IMPROVED ERROR LOGGING FOR DEBUGGING ***
                console.error("Firestore Attendance Snapshot Error:", error);
                const errorMessage = error.message.includes('permission denied') 
                    ? "ðŸ”´ PERMISSION DENIED: Check your Firestore Security Rules." 
                    : `Failed to fetch attendance data: ${error.message}`;
                showAlert(errorAlert, errorMessage);
            });
            
            // Listener 3: Wage Payments
            onSnapshot(query(paymentsCollection), (snapshot) => {
                paymentsListBody.innerHTML = '';
                paymentsList = []; // Reset list
                let recordIndex = 1;
                snapshot.forEach((doc) => {
                    const payment = doc.data();
                    paymentsList.push(payment); // Add to export list
                    const worker = workersMap[payment.workerId] || {}; // Lookup worker info
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    
                    // Format amounts
                    const dailyRate = payment.dailyRate || 0;
                    const daysWorked = payment.daysWorked || 0;
                    const deductions = payment.deductions || 0;
                    // Calculations done client-side for immediate feedback/simplicity
                    const grossPay = dailyRate * daysWorked; 
                    const netPay = grossPay - deductions;
                    
                    const displayNo = worker.workerNo || payment.workerId.substring(0, 5) + '...';

                    row.innerHTML = `
                        <td class="p-4 text-center">${recordIndex++}</td>
                        <td class="p-4">${new Date(payment.paymentDate).toLocaleDateString()}</td>
                        <td class="p-4 text-sm font-mono">${displayNo}</td>
                        <td class="p-4">${worker.workerFullName || 'N/A'}</td>
                        <td class="p-4">${worker.tradeRole || 'N/A'}</td>
                        <td class="p-4 text-right">$${dailyRate.toFixed(2)}</td>
                        <td class="p-4 text-center">${payment.daysWorked}</td>
                        <td class="p-4 text-right font-bold">$${grossPay.toFixed(2)}</td>
                        <td class="p-4 text-right text-red-600">-$${deductions.toFixed(2)}</td>
                        <td class="p-4 text-right font-bold text-green-700">$${netPay.toFixed(2)}</td>
                        <td class="p-4">${payment.paymentMethod || ''}</td>
                        <td class="p-4 text-sm text-gray-500">${payment.referenceNo || ''}</td>
                    `;
                    paymentsListBody.appendChild(row);
                });
                
                if (paymentsList.length === 0) {
                    paymentsListBody.innerHTML = '<tr><td colspan="12" class="p-6 text-center text-gray-500">No payment records yet.</td></tr>';
                }
                
            }, (error) => {
                // *** IMPROVED ERROR LOGGING FOR DEBUGGING ***
                console.error("Firestore Payments Snapshot Error:", error);
                const errorMessage = error.message.includes('permission denied') 
                    ? "ðŸ”´ PERMISSION DENIED: Check your Firestore Security Rules." 
                    : `Failed to fetch payments data: ${error.message}`;
                showAlert(errorAlert, errorMessage);
            });
        }


        // --- Form Submission Handlers (Unchanged) ---
        // 1. Labour Register Form
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            // Guard clause to ensure collection is ready
            if (!registerCollection) { 
                showAlert(errorAlert, "Database connection not ready. Please wait for the system to initialize."); 
                return; 
            }
            const formData = new FormData(registerForm);
            const newWorker = {
                workerNo: formData.get('worker_no') || '', 
                workerFullName: formData.get('name') || '', 
                nationalId: formData.get('id') || '', 
                homeLocation: formData.get('location') || '', 
                contactPhone: formData.get('phone') || '', 
                skillLevel: formData.get('skill') || '', 
                sex: formData.get('sex') || '', 
                tradeRole: formData.get('trade') || '', 
                startDate: formData.get('start_date') || '', 
                remarks: formData.get('remarks') || '', 
                createdAt: serverTimestamp() 
            };
            try {
                await addDoc(registerCollection, newWorker);
                showAlert(successAlert, `Worker [${newWorker.workerNo}] ${newWorker.workerFullName} added successfully!`);
                registerForm.reset();
            } catch (error) {
                console.error("Error adding worker: ", error);
                showAlert(errorAlert, `Failed to add worker: ${error.message}`);
            }
        });

        // 2. Attendance form submission logic
        attendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!attendanceCollection || !workersList.length) { 
                showAlert(errorAlert, !attendanceCollection ? "Database connection not ready." : "No workers registered yet."); 
                return; 
            }
            const formData = new FormData(attendanceForm);
            const newAttendance = {
                date: formData.get('date') || '', 
                workerId: formData.get('worker_id') || '', 
                location: formData.get('location') || '', 
                status: formData.get('status') || '', 
                hoursWorked: parseFloat(formData.get('hours')) || 0, 
                remarks: formData.get('remarks') || '', 
                createdAt: serverTimestamp() 
            };
            try {
                await addDoc(attendanceCollection, newAttendance);
                showAlert(successAlert, `Attendance recorded for worker successfully!`);
                attendanceForm.reset();
            } catch (error) {
                console.error("Error adding attendance: ", error);
                showAlert(errorAlert, `Failed to add attendance: ${error.message}`);
            }
        });

        // 3. Payments form submission logic
        paymentsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!paymentsCollection || !workersList.length) { 
                showAlert(errorAlert, !paymentsCollection ? "Database connection not ready." : "No workers registered yet."); 
                return; 
            }
            const formData = new FormData(paymentsForm);
            const dailyRate = parseFloat(formData.get('daily_rate')) || 0;
            const daysWorked = parseFloat(formData.get('days_worked')) || 0;
            const deductions = parseFloat(formData.get('deductions')) || 0;
            // Calculations done client-side for immediate feedback/simplicity
            const grossPay = dailyRate * daysWorked; 
            const netPay = grossPay - deductions;
            
            const newPayment = {
                paymentDate: formData.get('payment_date') || '', 
                workerId: formData.get('worker_id_payment') || '', 
                dailyRate: dailyRate, 
                daysWorked: daysWorked, 
                grossPay: grossPay, 
                deductions: deductions, 
                netPay: netPay, 
                paymentMethod: formData.get('payment_method') || '', 
                referenceNo: formData.get('reference_no') || '', 
                createdAt: serverTimestamp() 
            };
            try {
                await addDoc(paymentsCollection, newPayment);
                showAlert(successAlert, `Payment recorded for worker: $${netPay.toFixed(2)}`);
                paymentsForm.reset();
            } catch (error) {
                console.error("Error adding payment: ", error);
                showAlert(errorAlert, `Failed to record payment: ${error.message}`);
            }
        });


        window.onload = initFirebase;
    </script>
</head>
<body class="flex flex-col min-h-screen">
    <div class="container mx-auto p-4 sm:p-8 flex-grow">
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center">
            <div>
                <!-- Title Color is now Green-600 -->
                <h1 class="text-3xl font-extrabold text-emerald-600">Dhusamareb Road Package 1 Labour Management Record</h1>
                <p class="text-gray-600 mb-2">3-Sheet online workbook using real-time database.</p>
                <!-- Status now includes an icon for clarity -->
                <div id="auth-status" class="text-sm text-gray-500 flex items-center">
                    <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Connecting...
                </div>
            </div>
            <!-- Download Button using Biciv Accent Color (Cyan) -->
            <button onclick="downloadAllData()" class="mt-4 sm:mt-0 px-4 py-2 bg-cyan-600 text-white font-bold rounded-lg shadow-md hover:bg-cyan-700 transition duration-150 flex items-center form-submit-btn opacity-50 cursor-not-allowed" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                    <path fill-rule="evenodd" d="M10 18a.75.75 0 0 1-.75-.75V4.659l-1.953 1.954a.75.75 0 0 1-1.06-1.06l3.25-3.25a.75.75 0 0 1 1.06 0l3.25 3.25a.75.75 0 1 1-1.06 1.06l-1.953-1.954V17.25c0 .414-.336.75-.75.75Z" clip-rule="evenodd" />
                </svg>
                Download All Data (.csv)
            </button>
        </header>

        <!-- Alerts -->
        <div id="error-alert" role="alert" class="hidden items-center p-3 mb-4 text-sm text-red-800 rounded-lg bg-red-100" ></div>
        <div id="success-alert" role="alert" class="hidden items-center p-3 mb-4 text-sm text-green-800 rounded-lg bg-green-100" ></div>

        <!-- Navigation Tabs using Biciv Accent Color (Cyan) -->
        <nav class="flex border-b border-gray-200 mb-8">
            <button id="tab-register" onclick="switchView('register')" class="p-3 border-b-2 font-semibold transition duration-150 text-blue-800 border-cyan-500">
                1. Labour Register
            </button>
            <button id="tab-attendance" onclick="switchView('attendance')" class="p-3 border-b-2 font-semibold transition duration-150 text-gray-500 border-transparent hover:border-gray-300">
                2. Daily Attendance
            </button>
            <button id="tab-payments" onclick="switchView('payments')" class="p-3 border-b-2 font-semibold transition duration-150 text-gray-500 border-transparent hover:border-gray-300">
                3. Wage Payments
            </button>
        </nav>

        <!-- --- 1. Labour Register View --- -->
        <div id="register-view" class="view-content">
            <!-- Add New Worker Form -->
            <div class="form-card p-6 rounded-xl mb-8 border border-gray-200">
                <h2 class="text-xl font-semibold text-blue-800 mb-4">Add New Worker</h2>
                <form id="register-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    
                    <!-- Row 1: Added Worker No -->
                    <input type="text" name="worker_no" placeholder="Worker No. (e.g., W-001)" required class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                    <input type="text" name="name" placeholder="Full Name (Required)" required class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                    <input type="text" name="trade" placeholder="Trade / Role (e.g., Carpenter)" required class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                    <input type="text" name="id" placeholder="National ID / Passport No." class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                    
                    <!-- Row 2 -->
                    <input type="text" name="location" placeholder="Home Location / Village" class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                    <input type="tel" name="phone" placeholder="Contact Phone" class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                    <input type="date" name="start_date" placeholder="Start Date" required class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">

                    <!-- Row 3: Selects -->
                    <select name="skill" required class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                        <option value="" disabled selected>Select Skill Level</option>
                        <option value="Skilled">Skilled</option>
                        <option value="Semi-Skilled">Semi-Skilled</option>
                        <option value="Unskilled">Unskilled</option>
                    </select>
                    <select name="sex" required class="p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                        <option value="" disabled selected>Select Sex (M/F)</option>
                        <option value="M">M</option>
                        <option value="F">F</option>
                    </select>
                    
                    <input type="text" name="remarks" placeholder="Remarks" class="md:col-span-2 p-2 border border-gray-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500">
                    
                    <!-- Submit Button using Biciv Accent Color (Cyan) -->
                    <button type="submit" class="md:col-span-4 p-3 bg-cyan-600 text-white font-bold rounded-lg hover:bg-cyan-700 transition duration-150 form-submit-btn opacity-50 cursor-not-allowed" disabled>
                        Add Worker to Register
                    </button>
                </form>
            </div>

            <!-- Worker List Table -->
            <div class="table-container form-card rounded-xl border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">No.</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Worker Full Name</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Worker No.</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">National ID / Passport No.</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Home Location / Village</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Contact Phone</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">Skill Level</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">Sex (M/F)</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Trade / Role</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Start Date</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Remarks</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">Signature / Thumbprint</th>
                        </tr>
                    </thead>
                    <tbody id="worker-list-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="12" class="p-6 text-center text-gray-500">Loading worker data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- --- 2. Daily Attendance View --- -->
        <div id="attendance-view" class="view-content hidden">
             <!-- Record Attendance Form -->
            <div class="form-card p-6 rounded-xl mb-8 border border-gray-200">
                <h2 class="text-xl font-semibold text-amber-600 mb-4">Record Daily Attendance</h2>
                <form id="attendance-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    
                    <!-- Row 1 -->
                    <input type="date" name="date" required class="p-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500">
                    
                    <select name="worker_id" class="worker-select p-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500" required>
                        <option value="" disabled selected>Select Worker</option>
                        <!-- Options populated by JS -->
                    </select>

                    <select name="status" required class="p-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500">
                        <option value="" disabled selected>Status (P/A/L)</option>
                        <option value="P">Present (P)</option>
                        <option value="A">Absent (A)</option>
                        <option value="L">Leave (L)</option>
                    </select>
                    
                    <input type="number" name="hours" placeholder="Hours Worked (e.g., 8)" min="0" max="24" required class="p-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500">

                    <!-- Row 2 -->
                    <input type="text" name="location" placeholder="Location / Activity" class="md:col-span-2 p-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500">
                    <input type="text" name="remarks" placeholder="Remarks" class="p-2 border border-gray-300 rounded-lg focus:ring-amber-500 focus:border-amber-500">
                    
                    <!-- Submit Button -->
                    <button type="submit" class="p-3 bg-amber-600 text-white font-bold rounded-lg hover:bg-amber-700 transition duration-150 form-submit-btn opacity-50 cursor-not-allowed" disabled>
                        Record Attendance
                    </button>
                </form>
            </div>

            <!-- Attendance List Table -->
            <div class="table-container form-card rounded-xl border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="attendance-header">
                        <tr>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">No.</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Date</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Worker No.</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Worker Name</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Location / Activity</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">Status</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">Hours Worked</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-list-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="8" class="p-6 text-center text-gray-500">Loading attendance data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- --- 3. Wage Payments View --- -->
        <div id="payments-view" class="view-content hidden">
            <!-- Record Payments Form -->
            <div class="form-card p-6 rounded-xl mb-8 border border-gray-200">
                <h2 class="text-xl font-semibold text-green-600 mb-4">Record Wage Payment Transaction</h2>
                <form id="payments-form" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    
                    <!-- Row 1 -->
                    <input type="date" name="payment_date" required class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    <select name="worker_id_payment" class="worker-select p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" required>
                        <option value="" disabled selected>Select Worker</option>
                        <!-- Options populated by JS -->
                    </select>
                    <input type="number" name="daily_rate" placeholder="Daily Rate (USD)" step="0.01" min="0.01" required class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    <input type="number" name="days_worked" placeholder="Days Paid in Period" step="0.5" min="0" required class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">

                    <!-- Row 2 -->
                    <input type="number" name="deductions" placeholder="Deductions (USD)" step="0.01" value="0.00" min="0" required class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    <select name="payment_method" required class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                        <option value="" disabled selected>Payment Method</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank">Bank</option>
                        <option value="Mobile Money">Mobile Money</option>
                    </select>
                    <input type="text" name="reference_no" placeholder="Reference / Receipt No." class="p-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">
                    
                    <!-- Submit Button -->
                    <button type="submit" class="p-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 form-submit-btn opacity-50 cursor-not-allowed" disabled>
                        Record Payment
                    </button>
                </form>
            </div>

            <!-- Payments List Table -->
            <div class="table-container form-card rounded-xl border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="payments-header">
                        <tr>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">No.</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Payment Date</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Worker No.</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Worker Name</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Trade / Role</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-right">Daily Rate (USD)</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-center">Days Worked</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-right">Gross Pay (USD)</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-right">Deductions (USD)</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-right">Net Pay (USD)</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Payment Method</th>
                            <th class="p-4 text-xs font-medium text-gray-700 uppercase tracking-wider text-left">Reference / Receipt No.</th>
                        </tr>
                    </thead>
                    <tbody id="payments-list-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="12" class="p-6 text-center text-gray-500">Loading payment data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Footer for IP and Designer Attribution (Updated year and font) -->
    <footer class="mt-8 p-4 border-t border-gray-200 text-center bg-gray-50">
        <p class="text-sm text-gray-600 ip-font">
            &copy; 2025 Intellectual Property Rights Acknowledged for 
            <span class="font-bold text-blue-800">Biciv Designs & Construction Company Limited</span>.
        </p>
        <p class="text-xs text-gray-500 mt-1 ip-font">
            Designer: Eng Bill Ochieng.
        </p>
    </footer>
</body>
</html>